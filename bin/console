#!/usr/bin/env php
<?php

use App\Captcha\CaptchaService;
use App\Config;
use App\Cv\CvDataNormalizer;
use App\Cv\CvRenderer;
use App\Cv\CvStorage;
use App\Cv\RedactionService;
use App\Cv\CvValidator;
use App\Security\TokenService;
use App\Storage\FileStorage;
use App\Templating\TwigFactory;

$config = require __DIR__ . '/../src/bootstrap.php';

$rootPath = $config->rootPath();
$storage = new FileStorage();
$twig = TwigFactory::create($rootPath . '/templates');

$cvStorage = new CvStorage($storage, $rootPath . '/var/cache/html');
$renderer = new CvRenderer($twig);
$normalizer = new CvDataNormalizer();
$redactor = new RedactionService();
$validator = new CvValidator($rootPath . '/schemas/lebenslauf.schema.json');
$tokenService = new TokenService($storage, $rootPath . '/var/state/tokens');
$captchaService = new CaptchaService(
    $storage,
    $rootPath . '/var/tmp/captcha',
    $config->getInt('CAPTCHA_TTL_SECONDS', 600)
);

$argv = $_SERVER['argv'] ?? [];
$command = $argv[1] ?? '';

if ($command === 'cv:upload') {
    $profile = $argv[2] ?? '';
    $jsonPath = $argv[3] ?? '';

    if ($profile === '' || $jsonPath === '') {
        fwrite(STDERR, "Usage: cv:upload <PROFILE> <JSON_PATH>\n");
        exit(1);
    }

    if (!is_file($jsonPath)) {
        fwrite(STDERR, "JSON file not found: {$jsonPath}\n");
        exit(1);
    }

    $content = file_get_contents($jsonPath);
    $rawData = json_decode((string) $content);
    $data = json_decode((string) $content, true);
    if (!is_array($data) || $rawData === null) {
        fwrite(STDERR, "Invalid JSON: {$jsonPath}\n");
        exit(1);
    }

    $errors = $validator->validate($rawData);
    if (!empty($errors)) {
        fwrite(STDERR, "Schema validation failed:\n");
        foreach ($errors as $error) {
            fwrite(STDERR, "- {$error}\n");
        }
        exit(1);
    }

    $normalized = $normalizer->normalize($data);
    $privateHtml = $renderer->renderPrivate($normalized);
    $cvStorage->savePrivateHtml($profile, $privateHtml);

    $defaultProfile = (string) $config->get('DEFAULT_CV_PROFILE', 'DEFAULT');
    if (strcasecmp($profile, $defaultProfile) === 0) {
        $publicData = $redactor->redact($normalized);
        $publicHtml = $renderer->renderPublic($publicData);
        $cvStorage->savePublicHtml($publicHtml);
        fwrite(STDOUT, "Public CV rendered for profile {$profile}.\n");
    }

    fwrite(STDOUT, "Private CV rendered for profile {$profile}.\n");
    exit(0);
}

if ($command === 'token:rotate') {
    $profile = $argv[2] ?? '';
    $count = isset($argv[3]) ? (int) $argv[3] : 1;
    if ($profile === '') {
        fwrite(STDERR, "Usage: token:rotate <PROFILE> [COUNT]\n");
        exit(1);
    }

    $count = max(1, $count);
    $tokens = $tokenService->generateTokens($count);
    $tokenService->rotate($profile, $tokens);

    fwrite(STDOUT, "New tokens for {$profile}:\n");
    foreach ($tokens as $token) {
        fwrite(STDOUT, $token . "\n");
    }
    exit(0);
}

if ($command === 'captcha:cleanup') {
    $deleted = $captchaService->cleanupExpired();
    fwrite(STDOUT, "Deleted {$deleted} expired CAPTCHA files.\n");
    exit(0);
}

fwrite(STDERR, "Commands:\n");
fwrite(STDERR, "  cv:upload <PROFILE> <JSON_PATH>\n");
fwrite(STDERR, "  token:rotate <PROFILE> [COUNT]\n");
fwrite(STDERR, "  captcha:cleanup\n");
exit(1);
