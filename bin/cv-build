#!/usr/bin/env php
<?php

$rootPath = dirname(__DIR__);
$argv = $_SERVER['argv'] ?? [];

$envFile = null;
$profile = null;
$yamlPath = null;
$jsonPath = null;

for ($i = 1; $i < count($argv); $i++) {
    $arg = (string) $argv[$i];
    if ($arg === '--env' && isset($argv[$i + 1])) {
        $envFile = (string) $argv[++$i];
        continue;
    }
    if (str_starts_with($arg, '--env=')) {
        $envFile = substr($arg, strlen('--env='));
        continue;
    }
    if ($arg === '--json' && isset($argv[$i + 1])) {
        $jsonPath = (string) $argv[++$i];
        continue;
    }
    if (str_starts_with($arg, '--json=')) {
        $jsonPath = substr($arg, strlen('--json='));
        continue;
    }
    if ($arg === '--help' || $arg === '-h') {
        usage();
        exit(0);
    }
}

if ($envFile !== null) {
    putenv('APP_ENV_FILE=' . $envFile);
}

$config = require $rootPath . '/src/bootstrap.php';

$profile ??= (string) $config->get('CV_PROFILE', $config->get('DEFAULT_CV_PROFILE', 'DEFAULT'));
$yamlPath ??= resolveYamlPath($config, $rootPath);
$jsonPath ??= resolveJsonPath($config, $rootPath);

ensureDir(dirname($jsonPath), 'JSON output directory');

$yamlToJson = $rootPath . '/tools/yaml_to_json.py';
ensureFileExists($yamlToJson, 'yaml_to_json tool');

$console = $rootPath . '/bin/console';
ensureFileExists($console, 'console');

$targets = resolveYamlTargets($yamlPath, $profile);
foreach ($targets as $target) {
    ensureFileExists($target['yaml'], 'YAML');
    $convertCmd = buildCommand($yamlToJson, [$target['yaml'], $jsonPath]);
    runCommand($convertCmd, 'YAML to JSON conversion failed');

    $uploadCmd = buildCommand(PHP_BINARY, [$console, 'cv:upload', $target['profile'], $jsonPath]);
    runCommand($uploadCmd, 'CV upload failed');
    fwrite(STDOUT, "CV build completed: {$target['profile']} ({$target['yaml']})\n");
}

function resolveYamlPath($config, string $rootPath): string
{
    $fullPath = (string) $config->get('LEBENSLAUF_YAML_PFAD', '');
    if ($fullPath !== '') {
        return $fullPath;
    }

    $basePath = (string) $config->get('LEBENSLAUF_DATEN_PFAD', '');
    if ($basePath === '') {
        fail("Missing env: LEBENSLAUF_DATEN_PFAD or LEBENSLAUF_YAML_PFAD");
    }

    return $basePath;
}

function resolveJsonPath($config, string $rootPath): string
{
    $jsonPath = (string) $config->get('LEBENSLAUF_JSON_PFAD', '');
    if ($jsonPath !== '') {
        return $jsonPath;
    }

    return $rootPath . '/var/tmp/lebenslauf.json';
}

function resolveYamlTargets(string $yamlPath, string $defaultProfile): array
{
    if (is_dir($yamlPath)) {
        $entries = scandir($yamlPath);
        if ($entries === false) {
            fail("Unable to read YAML directory: {$yamlPath}");
        }
        $targets = [];
        foreach ($entries as $entry) {
            if (!is_string($entry)) {
                continue;
            }
            if (!preg_match('/^daten[-.](.+)\\.yaml$/i', $entry, $matches)) {
                continue;
            }
            $profile = $matches[1];
            $targets[] = [
                'profile' => $profile,
                'yaml' => rtrim($yamlPath, DIRECTORY_SEPARATOR) . DIRECTORY_SEPARATOR . $entry,
            ];
        }
        if (count($targets) === 0) {
            fail("No daten-*.yaml files found in: {$yamlPath}");
        }
        return $targets;
    }

    return [[
        'profile' => $defaultProfile,
        'yaml' => $yamlPath,
    ]];
}

function buildCommand(string $binary, array $args): string
{
    $escaped = array_map('escapeshellarg', $args);
    return escapeshellarg($binary) . ' ' . implode(' ', $escaped);
}

function runCommand(string $command, string $errorMessage): void
{
    passthru($command, $exitCode);
    if ($exitCode !== 0) {
        fail($errorMessage, $exitCode);
    }
}

function ensureFileExists(string $path, string $label): void
{
    if (!is_file($path)) {
        fail("{$label} not found: {$path}");
    }
}

function ensureDir(string $path, string $label): void
{
    if (is_dir($path)) {
        return;
    }
    if (!mkdir($path, 0775, true) && !is_dir($path)) {
        fail("{$label} missing and could not be created: {$path}");
    }
}

function usage(): void
{
    $lines = [
        "Usage: cv-build [--env <path>] [--json <path>]",
        "",
        "Env vars:",
        "  APP_ENV_FILE           optional env file override",
        "  LEBENSLAUF_DATEN_PFAD   directory containing daten-<profile>.yaml",
        "  LEBENSLAUF_YAML_PFAD    full path override (single file)",
        "  LEBENSLAUF_JSON_PFAD   output JSON path (default: var/tmp/lebenslauf.json)",
        "  CV_PROFILE             profile for cv:upload (default: DEFAULT_CV_PROFILE)",
    ];
    fwrite(STDOUT, implode(PHP_EOL, $lines) . PHP_EOL);
}

function fail(string $message, int $code = 1): void
{
    fwrite(STDERR, $message . PHP_EOL);
    exit($code);
}
