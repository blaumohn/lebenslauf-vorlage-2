#!/usr/bin/env php
<?php

$rootPath = dirname(__DIR__);
$argv = $_SERVER['argv'] ?? [];

$envFile = null;

for ($i = 1; $i < count($argv); $i++) {
    $arg = (string) $argv[$i];
    if ($arg === '--env' && isset($argv[$i + 1])) {
        $envFile = (string) $argv[++$i];
        continue;
    }
    if (str_starts_with($arg, '--env=')) {
        $envFile = substr($arg, strlen('--env='));
        continue;
    }
    if ($arg === '--help' || $arg === '-h') {
        usage();
        exit(0);
    }
}

if ($envFile !== null) {
    putenv('APP_ENV_FILE=' . $envFile);
}

$cvBuildCmd= renderCmdString(PHP_BINARY, [$rootPath . '/bin/cv-build']);
runCommand($cvBuildCmd, 'CV build failed');

$devCmd = renderCmdString(PHP_BINARY, [$rootPath . '/bin/dev']);
runCommand($devCmd, 'Dev server failed');

function renderCmdString(string $binary, array $args): string
{
    $escaped = array_map('escapeshellarg', $args);
    return escapeshellarg($binary) . ' ' . implode(' ', $escaped);
}

function runCommand(string $command, string $errorMessage): void
{
    passthru($command, $exitCode);
    if ($exitCode !== 0) {
        fail($errorMessage, $exitCode);
    }
}

function usage(): void
{
    $lines = [
        "Usage: cv-dev [--env <path>]",
        "",
        "Passes APP_ENV_FILE through to cv-build and dev.",
    ];
    fwrite(STDOUT, implode(PHP_EOL, $lines) . PHP_EOL);
}

function fail(string $message, int $code = 1): void
{
    fwrite(STDERR, $message . PHP_EOL);
    exit($code);
}
